// @ts-nocheck
const gameState={players:[{id:1,name:"Player 1",color:"red",cards:[],deck:[],isCurrent:!0},{id:2,name:"Player 2",color:"blue",cards:[],deck:[],isCurrent:!1},{id:3,name:"Player 3",color:"yellow",cards:[],deck:[],isCurrent:!1},{id:4,name:"Player 4",color:"green",cards:[],deck:[],isCurrent:!1}],board:Array(9).fill().map((()=>Array(9).fill(null))),currentPlayerIndex:0,selectedCard:null,gameStarted:!1,gameOver:!1,firstMove:!0,moveHistory:[],futureMoves:[],maxHistorySize:200,rulesVisible:!1},aiPlayers={1:!1,2:!1,3:!1,4:!1};document.getElementById("ai-p1").addEventListener("change",(e=>aiPlayers[1]=e.target.checked)),document.getElementById("ai-p2").addEventListener("change",(e=>aiPlayers[2]=e.target.checked)),document.getElementById("ai-p3").addEventListener("change",(e=>aiPlayers[3]=e.target.checked)),document.getElementById("ai-p4").addEventListener("change",(e=>aiPlayers[4]=e.target.checked));const gameBoard=document.getElementById("game-board"),gameMessage=document.getElementById("game-message"),currentPlayerDisplay=document.getElementById("current-player"),selectedCardDisplay=document.getElementById("selected-card-display"),startRestartGameBtn=document.getElementById("start-restart-game"),rulesBtn=document.getElementById("rules-btn"),rulesPanel=document.getElementById("rules-panel"),undoBtn=document.getElementById("undo-btn"),redoBtn=document.getElementById("redo-btn"),startPvcBtn=document.getElementById("start-pvc"),stopPvcBtn=document.getElementById("stop-pvc");class GameMove{constructor(e,t,a,r,n){this.board=JSON.parse(JSON.stringify(e)),this.players=JSON.parse(JSON.stringify(t)),this.currentPlayerIndex=a,this.firstMove=r,this.selectedCard=n?{...n}:null,this.timestamp=Date.now()}}function shuffle(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}if(!gameMessage){console.warn("Missing #game-message. Creating fallback.");const e=document.createElement("div");e.id="game-message",e.className="message",e.textContent="Welcome to Punto!",document.body.appendChild(e),gameMessage=document.getElementById("game-message")}function getCandidateImagePaths(e,t=null){const a=[];if(null!==t){const r=1===t?"krt":`krt${t}`;a.push(`${r}/py${e.value}.png`)}return e.color&&a.push(`images/${e.color}/${e.value}.png`),a.push(`images/generic/${e.value}.png`),a.push("images/placeholder.png"),a}function createImgWithFallback(e,t=""){const a=document.createElement("img");return a.alt=t,a.dataset._tryIndex=0,a.style.display="block",a.src=e[0],a.onerror=function(){let t=parseInt(this.dataset._tryIndex||"0",10)+1;t<e.length?(this.dataset._tryIndex=t,this.src=e[t]):this.style.display="none"},a}function showSelectedCardPreview(e,t=null){if(!e)return void showSelectedCardPreview(null);selectedCardDisplay.innerHTML="";const a=document.createElement("div");a.className=`player-card ${e.color}`;const r=createImgWithFallback(getCandidateImagePaths(e,t),`${e.color} ${e.value}`);a.appendChild(r);const n=document.createElement("span");n.className="card-number",n.textContent=e.value,a.appendChild(n),selectedCardDisplay.appendChild(a)}function showSelectedCardFromState(){const e=gameState.selectedCard;if(!e)return showSelectedCardPreview(null);const t=gameState.players.find((t=>t.id===e.playerId));if(!t)return showSelectedCardPreview(null);const a=t.cards[e.cardIndex];if(!a)return showSelectedCardPreview(null);showSelectedCardPreview(a,t.id)}function initializeBoard(){gameBoard.innerHTML="";for(let e=0;e<9;e++)for(let t=0;t<9;t++){const a=document.createElement("div");a.className="cell",a.dataset.row=e,a.dataset.col=t,4===e&&4===t&&a.classList.add("center-cell"),a.addEventListener("click",(()=>handleCellClick(e,t))),gameBoard.appendChild(a)}}function createFullDecks(){const e={red:[],blue:[],yellow:[],green:[]};for(let t=0;t<2;t++)for(let t=1;t<=9;t++)e.red.push({value:t,color:"red"}),e.blue.push({value:t,color:"blue"}),e.yellow.push({value:t,color:"yellow"}),e.green.push({value:t,color:"green"});return e}function initializePlayerCards(){const e=createFullDecks();gameState.players.forEach((t=>{const a=shuffle([...e[t.color]]);t.deck=a.slice(),t.cards=t.deck.slice(0,3),t.deck=t.deck.slice(3),updatePlayerCardsDisplay(t)}))}function drawCard(e){if(e.deck.length>0){const t=e.deck.shift();return e.cards.push(t),updatePlayerCardsDisplay(e),!0}return!1}function updatePlayerCardsDisplay(e){const t=document.getElementById(`player${e.id}-cards`);t.innerHTML="",e.cards.forEach(((a,r)=>{const n=document.createElement("div");n.className=`player-card ${a.color}`;const l=createImgWithFallback(getCandidateImagePaths(a,e.id),`${a.color} ${a.value}`);n.appendChild(l);const o=document.createElement("span");o.className="card-number",o.textContent=a.value,n.appendChild(o),n.addEventListener("click",(()=>handleCardSelect(e.id,r))),4===e.id&&9===a.value&&n.classList.add("special-card"),t.appendChild(n)})),updatePlayerHighlights()}function updatePlayerHighlights(){gameState.players.forEach((e=>{const t=document.getElementById(`player${e.id}`);e.isCurrent?t.classList.add("current-player"):t.classList.remove("current-player")}))}function updateCurrentPlayerDisplay(){currentPlayerDisplay.textContent=`${gameState.players[gameState.currentPlayerIndex].name}'s Turn`}function updateBoardDisplay(){for(let e=0;e<9;e++)for(let t=0;t<9;t++){const a=gameState.board[e][t],r=document.querySelector(`.cell[data-row="${e}"][data-col="${t}"]`);if(a){r.innerHTML="";const e=document.createElement("div");e.className=`card ${a.color}`;const t=createImgWithFallback(getCandidateImagePaths(a,a.playerId),`${a.color} ${a.value}`);e.appendChild(t);const n=document.createElement("span");n.className="card-number",n.textContent=a.value,e.appendChild(n),r.appendChild(e),r.classList.add("occupied")}else r.innerHTML="",r.classList.remove("occupied")}}function saveMoveToHistory(){const e=new GameMove(gameState.board,gameState.players,gameState.currentPlayerIndex,gameState.firstMove,gameState.selectedCard);gameState.moveHistory.push(e),gameState.futureMoves=[],gameState.moveHistory.length>gameState.maxHistorySize&&gameState.moveHistory.shift(),updateUndoRedoButtons()}function undoMove(){if(0===gameState.moveHistory.length||gameState.gameOver)return;const e=gameState.moveHistory.pop();gameState.futureMoves.push(e),gameState.board=e.board,gameState.players=e.players,gameState.currentPlayerIndex=e.currentPlayerIndex,gameState.firstMove=e.firstMove,gameState.selectedCard=e.selectedCard,gameState.gameOver=!1,updateBoardDisplay(),gameState.players.forEach((e=>updatePlayerCardsDisplay(e))),updatePlayerHighlights(),updateCurrentPlayerDisplay(),showSelectedCardFromState(),gameMessage.textContent="Move undone",updateUndoRedoButtons()}function redoMove(){if(0===gameState.futureMoves.length||gameState.gameOver)return;const e=gameState.futureMoves.pop();gameState.moveHistory.push(e),gameState.board=e.board,gameState.players=e.players,gameState.currentPlayerIndex=e.currentPlayerIndex,gameState.firstMove=e.firstMove,gameState.selectedCard=e.selectedCard,updateBoardDisplay(),gameState.players.forEach((e=>updatePlayerCardsDisplay(e))),updatePlayerHighlights(),updateCurrentPlayerDisplay(),showSelectedCardFromState(),gameMessage.textContent="Move redone",updateUndoRedoButtons()}function updateUndoRedoButtons(){undoBtn.disabled=0===gameState.moveHistory.length||gameState.gameOver,redoBtn.disabled=0===gameState.futureMoves.length||gameState.gameOver}function handleCardSelect(e,t){if(!gameState.gameStarted||gameState.gameOver)return;const a=gameState.players.find((t=>t.id===e));if(!a.isCurrent)return;if(gameState.selectedCard){const e=document.querySelectorAll(`#player${gameState.selectedCard.playerId}-cards .player-card`);e[gameState.selectedCard.cardIndex]&&e[gameState.selectedCard.cardIndex].classList.remove("selected")}gameState.selectedCard={playerId:e,cardIndex:t};const r=document.querySelectorAll(`#player${e}-cards .player-card`);r[t]&&r[t].classList.add("selected");const n=a.cards[t];showSelectedCardPreview(n,e),gameState.firstMove?gameMessage.textContent=`Selected: ${n.color} ${n.value}. Place at center (4,4).`:gameMessage.textContent=`Selected: ${n.color} ${n.value}. Choose a valid board position.`}function isValidMove(e,t,a){if(gameState.firstMove)return 4===e&&4===t;{const r=gameState.board[e][t];if(null!==r)return a.value>r.value;for(let a=-1;a<=1;a++)for(let r=-1;r<=1;r++){if(0===a&&0===r)continue;const n=e+a,l=t+r;if(n>=0&&n<9&&l>=0&&l<9&&null!==gameState.board[n][l])return!0}return!1}}function performPlacement(e,t,a,r){const n=e.cards[t];if(!isValidMove(a,r,n))return!1;if(saveMoveToHistory(),gameState.board[a][r]={value:n.value,color:n.color,playerId:e.id},e.cards.splice(t,1),drawCard(e),updateBoardDisplay(),updatePlayerCardsDisplay(e),gameState.firstMove){gameState.firstMove=!1;const e=document.querySelector(".cell.center-cell");e&&e.classList.remove("center-cell")}return checkWinCondition(e.id,a,r)?(gameState.gameOver=!0,gameMessage.textContent=`${e.name} wins! Four ${e.color} in a row!`,highlightWinningCells(e.id),gameState.selectedCard=null,showSelectedCardPreview(null),startRestartGameBtn.textContent="Restart Game",updateUndoRedoButtons(),!0):(nextPlayer(),gameState.selectedCard=null,showSelectedCardPreview(null),document.querySelectorAll(".player-card.selected").forEach((e=>e.classList.remove("selected"))),hasValidMoves()||(gameState.gameOver=!0,gameMessage.textContent="Game over! No valid moves remaining.",startRestartGameBtn.textContent="Restart Game"),updateUndoRedoButtons(),!0)}function handleCellClick(e,t){if(!gameState.gameStarted||gameState.gameOver)return;if(!gameState.selectedCard)return;const a=gameState.players.find((e=>e.id===gameState.selectedCard.playerId));if(!a.isCurrent)return;performPlacement(a,gameState.selectedCard.cardIndex,e,t)||(gameState.firstMove?gameMessage.textContent="First move must be center (4,4).":gameMessage.textContent="Invalid move! Choose an adjacent empty square or valid stack.")}function checkWinCondition(e,t,a){const r=gameState.players.find((t=>t.id===e)).color;for(let e=0;e<=5;e++){let a=0;for(let n=0;n<4;n++){const l=gameState.board[t][e+n];if(!l||l.color!==r)break;a++}if(4===a)return!0}for(let e=0;e<=5;e++){let t=0;for(let n=0;n<4;n++){const l=gameState.board[e+n][a];if(!l||l.color!==r)break;t++}if(4===t)return!0}for(let e=0;e<=5;e++)for(let t=0;t<=5;t++){let a=0;for(let n=0;n<4;n++){const l=gameState.board[e+n][t+n];if(!l||l.color!==r)break;a++}if(4===a)return!0}for(let e=0;e<=5;e++)for(let t=3;t<9;t++){let a=0;for(let n=0;n<4;n++){const l=gameState.board[e+n][t-n];if(!l||l.color!==r)break;a++}if(4===a)return!0}return!1}function highlightWinningCells(e){const t=gameState.players.find((t=>t.id===e)).color;for(let e=0;e<9;e++)for(let a=0;a<9;a++){const r=gameState.board[e][a];if(r&&r.color===t){const t=document.querySelector(`.cell[data-row="${e}"][data-col="${a}"]`);t&&t.classList.add("winning-cells")}}}function hasValidMoves(){for(const e of gameState.players)if(0!==e.cards.length)for(let t=0;t<9;t++)for(let a=0;a<9;a++)for(const r of e.cards)if(isValidMove(t,a,r))return!0;return!1}function nextPlayer(){if(gameState.players[gameState.currentPlayerIndex].isCurrent=!1,gameState.currentPlayerIndex=(gameState.currentPlayerIndex+1)%gameState.players.length,gameState.players[gameState.currentPlayerIndex].isCurrent=!0,updatePlayerHighlights(),updateCurrentPlayerDisplay(),gameMessage.textContent=`${gameState.players[gameState.currentPlayerIndex].name}'s turn. Select a card.`,0===gameState.players[gameState.currentPlayerIndex].cards.length)return void nextPlayer();const e=gameState.players[gameState.currentPlayerIndex];aiPlayers[e.id]&&!gameState.gameOver&&setTimeout((()=>computerMove(e)),280)}function simulatePlaceAndCheck(e,t,a,r,n){const l=e.map((e=>e.map((e=>e?{...e}:null))));l[t][a]={color:r,value:n};for(let e=0;e<9;e++)for(let t=0;t<=5;t++){let a=0;for(let n=0;n<4;n++){const o=l[e][t+n];if(!o||o.color!==r)break;a++}if(4===a)return!0}for(let e=0;e<9;e++)for(let t=0;t<=5;t++){let a=0;for(let n=0;n<4;n++){const o=l[t+n][e];if(!o||o.color!==r)break;a++}if(4===a)return!0}for(let e=0;e<=5;e++)for(let t=0;t<=5;t++){let a=0;for(let n=0;n<4;n++){const o=l[e+n][t+n];if(!o||o.color!==r)break;a++}if(4===a)return!0}for(let e=0;e<=5;e++)for(let t=3;t<9;t++){let a=0;for(let n=0;n<4;n++){const o=l[e+n][t-n];if(!o||o.color!==r)break;a++}if(4===a)return!0}return!1}function evaluateMove(e,t,a,r){let n=0;const l=r.color;if(simulatePlaceAndCheck(gameState.board,e,t,l,a.value))return n+=1e5,n;const o=gameState.board[e][t];o&&a.value>o.value&&(n+=250);let s=0;for(let a=-1;a<=1;a++)for(let r=-1;r<=1;r++){if(0===a&&0===r)continue;const n=e+a,o=t+r;if(n>=0&&n<9&&o>=0&&o<9){const e=gameState.board[n][o];e&&e.color===l&&s++}}n+=80*s;for(const a of gameState.players)if(a.id!==r.id)for(const r of a.cards)isValidMove(e,t,r)&&simulatePlaceAndCheck(gameState.board,e,t,a.color,r.value)&&(n+=450);return n-=4*(Math.abs(e-4)+Math.abs(t-4)),n+=8*Math.random(),n}function computerMove(e){if(!e||0===e.cards.length||gameState.gameOver)return;let t={score:-1/0,row:null,col:null,cardIndex:null};for(let a=0;a<e.cards.length;a++){const r=e.cards[a];for(let n=0;n<9;n++)for(let l=0;l<9;l++){if(!isValidMove(n,l,r))continue;const o=evaluateMove(n,l,r,e);o>t.score&&(t.score=o,t.row=n,t.col=l,t.cardIndex=a)}}null!==t.cardIndex?(performPlacement(e,t.cardIndex,t.row,t.col),gameMessage.textContent=`${e.name} (AI) placed a card.`):(gameMessage.textContent=`${e.name} (AI) has no valid move and is skipped.`,nextPlayer())}function startRestartGame(){gameState.gameStarted=!0,gameState.gameOver=!1,gameState.firstMove=!0,gameState.currentPlayerIndex=0,gameState.selectedCard=null,gameState.moveHistory=[],gameState.futureMoves=[],gameState.board=Array(9).fill().map((()=>Array(9).fill(null))),gameState.players.forEach(((e,t)=>{e.isCurrent=0===t,e.cards=[],e.deck=[]})),initializeBoard(),initializePlayerCards(),updateBoardDisplay(),showSelectedCardPreview(null),currentPlayerDisplay.textContent=`${gameState.players[0].name}'s Turn`,gameMessage.textContent="Game started! Player 1, place a card in center.",startRestartGameBtn.textContent="Reset Game",updateUndoRedoButtons();const e=gameState.players[gameState.currentPlayerIndex];aiPlayers[e.id]&&setTimeout((()=>computerMove(e)),280)}function setupCustomCursor(){const e=document.getElementById("customCursor");if(!e)return;const t=e.querySelector("img");if("ontouchstart"in window||navigator.maxTouchPoints>0)return e.style.display="none",document.documentElement.classList.remove("custom-cursor-active"),void document.body.classList.remove("custom-cursor-active");document.documentElement.classList.add("custom-cursor-active"),document.body.classList.add("custom-cursor-active");let a=!1;function r(t){e.style.left=t.clientX+"px",e.style.top=t.clientY+"px"}window.addEventListener("mousemove",(function t(n){a||(e.style.opacity="1",a=!0,window.removeEventListener("mousemove",t)),r(n)}),{passive:!0}),window.addEventListener("mousemove",r,{passive:!0}),window.addEventListener("mousedown",(()=>e.classList.add("click"))),window.addEventListener("mouseup",(()=>e.classList.remove("click")));let n;window.addEventListener("dblclick",(()=>{t&&(t.src="krusor2.png",clearTimeout(n),n=setTimeout((()=>{t.src="krusor1.png"}),800))})),window.addEventListener("mouseout",(t=>{t.relatedTarget||(e.style.opacity="0")})),window.addEventListener("mouseover",(()=>{a&&(e.style.opacity="1")}))}function setupBGM(){const e=document.getElementById("bgm");if(!e)return;e.volume=0,e.loop=!0,e.preload="auto";let t=!1,a=null;function r(t=.5,r=700){a&&clearInterval(a);const n=Math.max(20,Math.floor(r/20)),l=e.volume,o=t-l;let s=0;a=setInterval((()=>{s++,e.volume=Math.min(1,Math.max(0,l+o*(s/20))),s>=20&&(clearInterval(a),a=null)}),n)}function n(){if(t)return;const a=e.play();a&&"function"==typeof a.then?a.then((()=>{t=!0,r(.5,700)})).catch((()=>{})):(t=!0,r(.5,700)),["click","dblclick","mousemove","keydown"].forEach((e=>window.removeEventListener(e,n)))}["click","dblclick","mousemove","keydown"].forEach((e=>window.addEventListener(e,n,{passive:!0})))}startPvcBtn.addEventListener("click",(()=>{aiPlayers[1]=!1,aiPlayers[2]=!0,aiPlayers[3]=!1,aiPlayers[4]=!1,document.getElementById("ai-p1").checked=!1,document.getElementById("ai-p2").checked=!0,document.getElementById("ai-p3").checked=!1,document.getElementById("ai-p4").checked=!1,gameMessage.textContent="Mode: Player 1 vs Computer (Player 2). Starting game...",startRestartGame()})),stopPvcBtn.addEventListener("click",(()=>{aiPlayers[1]=!1,aiPlayers[2]=!1,aiPlayers[3]=!1,aiPlayers[4]=!1,document.getElementById("ai-p1").checked=!1,document.getElementById("ai-p2").checked=!1,document.getElementById("ai-p3").checked=!1,document.getElementById("ai-p4").checked=!1,gameMessage.textContent="AI mode stopped. All players set to human. Resetting game...",startRestartGame()})),startRestartGameBtn.addEventListener("click",startRestartGame),rulesBtn.addEventListener("click",(()=>{gameState.rulesVisible=!gameState.rulesVisible,rulesPanel.style.display=gameState.rulesVisible?"block":"none",rulesBtn.textContent=gameState.rulesVisible?"Hide Rules":"Show Rules"})),undoBtn.addEventListener("click",undoMove),redoBtn.addEventListener("click",redoMove),window.addEventListener("load",(()=>{initializeBoard(),startRestartGame()}));
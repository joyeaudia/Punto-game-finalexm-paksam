// @ts-nocheck
const boardEl=document.getElementById("game-board"),controlCardsContainer=document.getElementById("control-player-cards"),btnReset=document.getElementById("btn-reset"),btnSample=document.getElementById("btn-sample"),bgm=document.getElementById("bgm");function logMsg(e){console.log(e)}function shuffle(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}function getCandidateImagePaths(e,t=null){const a=[];if(null!==t){const l=1===t?"krt":`krt${t}`;a.push(`${l}/py${e.value}.png`),a.push(`${l}/${e.value}.png`)}return e.color&&a.push(`images/${e.color}/${e.value}.png`),a.push(`images/generic/${e.value}.png`),a.push("images/placeholder.png"),a}function createImgWithFallback(e,t=""){const a=document.createElement("img");return a.alt=t,a.dataset._tryIndex=0,a.src=e[0]||"",a.style.display="block",a.onerror=function(){let t=parseInt(this.dataset._tryIndex||"0",10)+1;t<e.length?(this.dataset._tryIndex=t,this.src=e[t]):this.style.display="none"},a}const gameState={size:9,board:[],players:[],currentPlayerIndex:0,selectedCard:null};let lockUntil=0,gameClockSeconds=1,clockInterval=null,uiClockEl=null,uiCooldownEl=null;function injectClockUI(){const e=document.querySelector(".controls-panel");if(!e)return;const t=document.createElement("div");t.style.width="100%",t.style.display="flex",t.style.justifyContent="space-between",t.style.alignItems="center",t.style.gap="8px",t.style.marginBottom="6px";const a=document.createElement("div");a.id="game-clock",a.style.fontWeight="800",a.style.color="#6b2b57",a.style.fontSize="1rem",a.textContent=formatTime(gameClockSeconds),uiClockEl=a;const l=document.createElement("div");l.id="game-cooldown",l.style.fontSize="0.86rem",l.style.color="rgba(0,0,0,0.6)",l.textContent="Ready",uiCooldownEl=l,t.appendChild(a),t.appendChild(l),e.insertBefore(t,e.firstChild)}function formatTime(e){const t=Math.floor(e/60),a=e%60;return`${String(t).padStart(2,"0")}:${String(a).padStart(2,"0")}`}function startClock(){clockInterval&&clearInterval(clockInterval),uiClockEl&&(uiClockEl.textContent=formatTime(gameClockSeconds)),clockInterval=setInterval((()=>{gameClockSeconds++,uiClockEl&&(uiClockEl.textContent=formatTime(gameClockSeconds)),refreshCooldownUI()}),1e3)}function refreshCooldownUI(){if(!uiCooldownEl)return;const e=Date.now();if(e<lockUntil){const t=lockUntil-e,a=Math.ceil(t/1e3);uiCooldownEl.textContent=`Wait ${String(a).padStart(2,"0")}s`,uiCooldownEl.style.color="#c94a6b"}else uiCooldownEl.textContent="Ready",uiCooldownEl.style.color="rgba(0,0,0,0.6)"}function createFullDecks(){const e={red:[],blue:[],yellow:[],green:[]};for(let t=0;t<2;t++)for(let a=1;a<=9;a++)e.red.push({value:a,color:"red",id:`red-${t}-${a}`}),e.blue.push({value:a,color:"blue",id:`blue-${t}-${a}`}),e.yellow.push({value:a,color:"yellow",id:`yellow-${t}-${a}`}),e.green.push({value:a,color:"green",id:`green-${t}-${a}`});return e}function initializePlayers(){const e=["red","blue","yellow","green"],t=createFullDecks();gameState.players=[];for(let a=0;a<4;a++){const l=e[a],n=shuffle(t[l].slice()),o=n.splice(0,3);gameState.players.push({id:a+1,name:`Player ${a+1}`,color:l,cards:o,deck:n})}gameState.currentPlayerIndex=0,gameState.selectedCard=null}function initializeBoard(){if(gameState.board=Array.from({length:gameState.size},(()=>Array(gameState.size).fill(null))),boardEl){boardEl.innerHTML="";for(let e=0;e<gameState.size;e++)for(let t=0;t<gameState.size;t++){const a=document.createElement("div");a.className="cell",a.dataset.row=e,a.dataset.col=t,e===Math.floor(gameState.size/2)&&t===Math.floor(gameState.size/2)&&a.classList.add("center"),a.addEventListener("click",(()=>handleCellClick(e,t))),boardEl.appendChild(a)}updateBoardDisplay()}}function updateBoardDisplay(){if(boardEl)for(let e=0;e<gameState.size;e++)for(let t=0;t<gameState.size;t++){const a=gameState.board[e][t],l=boardEl.querySelector(`.cell[data-row="${e}"][data-col="${t}"]`);if(l&&(l.innerHTML="",a)){const n=document.createElement("div");n.className=`placed-card card ${a.color}`,n.dataset.playerId=a.playerId,n.dataset.value=a.value,n.dataset.placedId=a.placedId||`${a.playerId}-${a.value}-${Date.now()}`;const o=createImgWithFallback(getCandidateImagePaths(a,a.playerId),`${a.color} ${a.value}`);n.appendChild(o);const r=document.createElement("span");r.className="card-number",r.textContent=a.value,r.style.left="6px",r.style.bottom="6px",r.style.transform="none",r.style.zIndex="8",n.appendChild(r),n.addEventListener("click",(l=>{l.stopPropagation();const o=parseInt(n.dataset.playerId,10),r=getPlayerById(o);if(!r)return;gameState.board[e][t]=null;const d={value:a.value,color:a.color,id:`ret-${o}-${a.value}-${Date.now()}`};r.cards.push(d),1===r.id&&updatePlayerCardsDisplay(r),updateBoardDisplay(),logMsg(`${r.name} gets card ${a.value} back.`)})),l.appendChild(n)}}}function getPlayerById(e){return gameState.players.find((t=>t.id===e))||null}function drawCard(e){if(!e)return!1;if(e.deck&&e.deck.length>0){const t=e.deck.shift();return e.cards.push(t),!0}return!1}function updatePlayerCardsDisplay(e){if(!controlCardsContainer||!e)return;controlCardsContainer.innerHTML="";const t=e.cards.slice(0,3);t.forEach(((t,a)=>{const l=document.createElement("div");l.className=`player-card ${t.color} in-hand`,l.dataset.cardId=t.id,l.dataset.cardIndex=a;const n=createImgWithFallback(getCandidateImagePaths(t,e.id),`${t.color} ${t.value}`);l.appendChild(n);const o=document.createElement("span");o.className="card-number",o.textContent=t.value,l.appendChild(o),l.addEventListener("click",(a=>{a.stopPropagation(),handleCardSelect(e.id,t.id)})),gameState.selectedCard&&gameState.selectedCard.cardId===t.id&&l.classList.add("selected"),controlCardsContainer.appendChild(l)}));for(let e=t.length;e<3;e++){const e=document.createElement("div");e.className="player-card placeholder",e.style.opacity="0.04",controlCardsContainer.appendChild(e)}}function handleCardSelect(e,t){const a=Date.now();if(a<lockUntil){return logMsg(`Please wait ${Math.ceil((lockUntil-a)/1e3)}s before selecting another card.`),void refreshCooldownUI()}const l=gameState.players[gameState.currentPlayerIndex];if(!l)return;if(l.id!==e)return void logMsg(`Not ${getPlayerById(e).name}'s turn.`);const n=getPlayerById(e);if(!n)return void logMsg("Player not found");const o=n.cards.findIndex((e=>e.id===t));-1!==o?(gameState.selectedCard={playerId:e,cardId:t,cardIndexInHand:o},1===n.id&&updatePlayerCardsDisplay(n),logMsg(`${n.name}: selected ${n.cards[o].value}. Click a board cell to place.`)):logMsg("Card not found in hand.")}function handleCellClick(e,t){const a=gameState.selectedCard;if(!a)return;const l=getPlayerById(a.playerId);if(!l)return void(gameState.selectedCard=null);if(gameState.board[e][t])return void logMsg("Cell already occupied.");const n=l.cards.findIndex((e=>e.id===a.cardId));if(-1===n)return logMsg("Card no longer in hand."),gameState.selectedCard=null,void(1===l.id&&updatePlayerCardsDisplay(l));const o=l.cards[n],r={value:o.value,color:o.color,playerId:l.id,placedId:`${l.id}-${o.id}-${Date.now()}`};gameState.board[e][t]=r,l.cards.splice(n,1),drawCard(l),lockUntil=Date.now()+6e3,refreshCooldownUI(),gameState.selectedCard=null,1===l.id&&updatePlayerCardsDisplay(l),updateBoardDisplay(),logMsg(`${l.name} placed ${r.value} at [${e},${t}].`)}function resetGame(){initializePlayers(),initializeBoard();const e=getPlayerById(1);e&&updatePlayerCardsDisplay(e),updateBoardDisplay(),gameClockSeconds=1,lockUntil=0,refreshCooldownUI()}function sampleAction(){alert("Sample button pressed.")}function setupBgmAutoplay(){if(!bgm)return;bgm.volume=0;let e=!1;function t(e=.28,t=700){const a=Math.max(20,Math.floor(t/20)),l=bgm.volume,n=e-l;let o=0;const r=setInterval((()=>{o++,bgm.volume=Math.min(1,Math.max(0,l+n*(o/20))),o>=20&&clearInterval(r)}),a)}function a(){if(e)return;const l=bgm.play();l&&"function"==typeof l.then?l.then((()=>{e=!0,t()})).catch((()=>{})):(e=!0,t()),["click","mousemove","keydown"].forEach((e=>window.removeEventListener(e,a)))}["click","mousemove","keydown"].forEach((e=>window.addEventListener(e,a,{passive:!0})))}document.addEventListener("DOMContentLoaded",(()=>{injectClockUI(),startClock(),initializePlayers(),initializeBoard();const e=getPlayerById(1);e&&updatePlayerCardsDisplay(e),updateBoardDisplay(),btnReset&&btnReset.addEventListener("click",resetGame),btnSample&&btnSample.addEventListener("click",sampleAction),setInterval(refreshCooldownUI,200),setupBgmAutoplay()}));